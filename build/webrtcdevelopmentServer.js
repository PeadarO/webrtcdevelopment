exports.redisscipts=function(){const a=require("redis"),b=require("redis-server");return module.startServer=function(){const a=process.env.REDIS_PORT||6379,c=new b(a);c.open(a=>{null===a&&(console.log("----------------Redis----------------------"),console.log("[Redis] Redis server started"))})},module.startclient=function(){const b=a.createClient();return b.on("error",function(a){console.error(a)}),b.set("key","value",a.print),b.get("key",a.print),b},module};
exports.realtimecomm=function(a,b,c,d,e){async function f(a){try{var b=k[a.userid],c={};b&&b.extra&&(c=b.extra);let d={socket:a,connectedWith:{},isPublic:!1,extra:c||{}};k[a.userid]=d}catch(a){console.error(a)}}function g(a){function b(b){try{if(!k[b.sender])return void a.emit("user-not-found",b.sender);b.message.userLeft||k[b.sender].connectedWith[b.remoteUserId]||!k[b.remoteUserId]||(k[b.sender].connectedWith[b.remoteUserId]=k[b.remoteUserId].socket,k[b.sender].socket.emit("user-connected",b.remoteUserId),!k[b.remoteUserId]&&(k[b.remoteUserId]={socket:null,connectedWith:{},isPublic:!1,extra:{}}),k[b.remoteUserId].connectedWith[b.sender]=a,k[b.remoteUserId].socket&&k[b.remoteUserId].socket.emit("user-connected",b.sender)),k[b.sender].connectedWith[b.remoteUserId]&&k[a.userid]&&(b.extra=k[a.userid].extra,k[b.sender].connectedWith[b.remoteUserId].emit(d,b))}catch(a){pushLogs("onMessageCallback",a)}}var c=a.handshake.query,d=c.msgEvent||"RTCMultiConnection-Message";c.enableScalableBroadcast&&(!h&&(h=require("./Scalable-Broadcast.js")),h(a,c.maxRelayLimitPerUser));a.userid=c.userid,f(a),a.on("extra-data-updated",function(b){try{if(!k[a.userid])return;for(var c in k[a.userid].extra=b,k[a.userid].connectedWith)k[c].socket.emit("extra-data-updated",a.userid,b)}catch(a){pushLogs("extra-data-updated",a)}}),a.on("changed-uuid",function(b,d){if(d=d||function(){},c.dontUpdateUserId)return void delete c.dontUpdateUserId;try{if(k[a.userid]&&k[a.userid].socket.id==a.userid){if(b===a.userid)return;var e=a.userid;return k[b]=k[e],k[b].socket.userid=a.userid=b,delete k[e],void d()}a.userid=b,f(a),d()}catch(a){pushLogs("changed-uuid",a)}}),a.on("set-password",function(b){try{k[a.userid]&&(k[a.userid].password=b)}catch(a){pushLogs("set-password",a)}}),a.on("disconnect-with",function(b,c){try{if(k[a.userid]&&k[a.userid].connectedWith[b]&&(delete k[a.userid].connectedWith[b],a.emit("user-disconnected",b)),!k[b])return c();k[b].connectedWith[a.userid]&&(delete k[b].connectedWith[a.userid],k[b].socket.emit("user-disconnected",a.userid)),c()}catch(a){pushLogs("disconnect-with",a)}}),a.on("close-entire-session",function(b){try{var c=k[a.userid].connectedWith;Object.keys(c).forEach(function(b){if(c[b]&&c[b].emit)try{c[b].emit("closed-entire-session",a.userid,k[a.userid].extra)}catch(a){}}),delete l[a.userid],b()}catch(a){pushLogs("close-entire-session",a)}}),a.on("check-presence",function(b,c){if(b===a.userid&&!!k[b])return void c(!1,a.userid,k[b].extra);var d={};k[b]&&(d=k[b].extra),c(!!k[b],b,d)}),a.on("open-channel",function(b){console.log("------------open channel------------- ",b.channel," by ",b.sender);var c=null;b.channel?c=b.channel:console.log(" Err :  channel is empty"),0>n.indexOf(c)?(n.push(c),console.log("registered new in channels ",n)):console.log("channel already exists channels ",n);try{m[c]={channel:c,timestamp:new Date().toLocaleString(),maxAllowed:b.maxAllowed,users:[b.sender],status:"waiting",endtimestamp:0,log:[new Date().toLocaleString()+":-channel created . User "+b.sender+" waiting "]},console.log("information added to channel",m)}catch(a){console.log(" Err : info couldnt be aded to channel ",a)}var d={status:!0,channel:c};a.emit("open-channel-resp",d)}),a.on("open-channel-screenshare",function(b){console.log("------------open channel screenshare------------- ",b.channel," by ",b.sender);var c={status:!0,channel:b.channel};a.emit("open-channel-screenshare-resp",c)}),a.on("join-channel",function(b){var c=!1,d=b.channel;if((m[b.channel].users.length<m[b.channel].maxAllowed||"unlimited"==m[b.channel].maxAllowed)&&(c=!0),console.log("------------join channel------------- ",b.channel," by ",b.sender," isallowed ",c),c){m[b.channel].users.push(b.sender),m[b.channel].status=m[b.channel].users.length+" active members",m[b.channel].log.push(new Date().toLocaleString()+":-User "+b.sender+" joined the channel ");var e={status:!0,channel:b.channel,users:m[b.channel].users};a.emit("join-channel-resp",e);var f={status:!0,type:"new-join",msgtype:"success",data:b};a.broadcast.emit("channel-event",f)}else{console.warn(" Not aloowed to join channel , maxAllowed : ",m[b.channel].maxAllowed," current-users : ",m[b.channel].users.length);var e={status:!1,msgtype:"error",msg:"Sorry cant join this channel"};a.emit("join-channel-resp",e);var f={status:!0,type:"new-join",msgtype:"error",msg:"Another user is trying to join this channel but max count [ "+m[b.channel].maxAllowed+" ] is reached"};a.broadcast.emit("channel-event",f)}}),a.on("update-channel",function(a){switch(console.log("------------update channel------------- ",a.channel," by ",a.sender," -> ",a),a.type){case"change-userid":var b=m[a.channel].users.indexOf(a.extra.old);console.log("old userid",m[a.channel].users[b]),m[a.channel].users[b]=a.extra.new,console.log("changed userid",m[a.channel].users);break;default:console.log("do nothing ");}}),a.on("presence",function(b){var c=!!m[b.channel];console.log(" Presence Check index of ",b.channel," is ",c),a.emit("presence",c)}),a.on("admin_enquire",function(b){switch(b.ask){case"channels":b.find?a.emit("response_to_admin_enquire",module.getChannel(b.find,b.format)):a.emit("response_to_admin_enquire",module.getAllChannels(b.format));break;case"users":a.emit("response_to_admin_enquire",module.getAllActiveUsers(b.format));break;case"channel_clients":a.emit("response_to_admin_enquire",module.getChannelClients(b.channel));break;default:a.emit("response_to_admin_enquire","no case matched ");}});var g=0;a.on(d,function(c,d){if(!(c.remoteUserId&&c.remoteUserId===a.userid))try{if(c.remoteUserId&&"system"!=c.remoteUserId&&c.message.newParticipationRequest&&k[c.remoteUserId]&&k[c.remoteUserId].password){if(3<g)return void a.emit("password-max-tries-over",c.remoteUserId);if(!c.password)return g++,void a.emit("join-with-password",c.remoteUserId);if(c.password!=k[c.remoteUserId].password)return g++,void a.emit("invalid-password",c.remoteUserId,c.password)}if(c.message.shiftedModerationControl)return c.message.firedOnLeave?void(l[c.sender]=c):void b(c);if("system"==c.remoteUserId&&c.message.detectPresence)return c.message.userid===a.userid?void d(!1,a.userid):void d(!!k[c.message.userid],c.message.userid);if(k[c.sender]||(k[c.sender]={socket:a,connectedWith:{},isPublic:!1,extra:{}}),c.message.newParticipationRequest){var e=0;return void function d(){return e++,120<e?void a.emit("user-not-found",c.remoteUserId):k[c.remoteUserId]&&k[c.remoteUserId].socket?void b(c):void setTimeout(d,1e3)}()}b(c)}catch(a){pushLogs("on-socketMessageEvent",a)}}),a.on("disconnect",function(){try{delete a.namespace.sockets[this.id]}catch(a){pushLogs("disconnect",a)}try{var c=l[a.userid];c&&(delete l[c.userid],b(c))}catch(a){pushLogs("disconnect",a)}try{if(k[a.userid])for(var d in k[a.userid].connectedWith)k[a.userid].connectedWith[d].emit("user-disconnected",a.userid),k[d]&&k[d].connectedWith[a.userid]&&(delete k[d].connectedWith[a.userid],k[d].socket.emit("user-disconnected",a.userid))}catch(a){pushLogs("disconnect",a)}delete k[a.userid]}),e&&e(a)}var h,k={},l={},m={},n=[],o={},p=require("socket.io");try{p=p(a),p.origins("*:*"),p.on("connection",g)}catch(a){console.error(" Realtime connection threw Exception ",a)}return module.getAll=function(a){var b=[];for(i in m)b.push(m[i]);return{response:"channels",channels:b,format:a}},module.getAllChannels=function(a){var b=[];for(i in Object.keys(m))b.push(Object.keys(m)[i]);return{response:"all",channelinfo:b,format:a}},module.getChannel=function(a,b){var c={response:"channel",channelinfo:m[a]?m[a]:null,format:b};return c},module.getAllActiveUsers=function(a){var b=[];for(i in Object.keys(m)){var c=Object.keys(m)[i];for(j in m[c].users)b.push(m[c].users[j])}return{response:"users",users:b,format:a}},module.getUser=function(a,b){var c={response:"users",users:o[a]?o[a]:"notfound",format:b};return c},module.getChannelClients=function(a){var b={response:"users",clients:p.of("/"+a).clients(),format:data.format};return b},console.log("----------------realtimecomm----------------------"),console.log(" Socket.io env => "+b.enviornment+" running at\n "+b.httpsPort),module};var enableLogs=!1;try{var _enableLogs=require("./config.json").enableLogs;_enableLogs&&(enableLogs=!0)}catch(a){enableLogs=!1}var fs=require("fs");function pushLogs(){if(enableLogs){var a=process.cwd()+"/logs.json",b=new Date().toUTCString().replace(/ |-|,|:|\./g,"");uncache(a);var c={};try{c=require(a)}catch(a){}arguments[1]&&arguments[1].stack&&(arguments[1]=arguments[1].stack);try{c[b]=JSON.stringify(arguments,null,"\t"),fs.writeFileSync(a,JSON.stringify(c,null,"\t"))}catch(a){c[b]=arguments.toString()}}}function uncache(a){searchCache(a,function(a){delete require.cache[a.id]}),Object.keys(module.constructor._pathCache).forEach(function(b){0<b.indexOf(a)&&delete module.constructor._pathCache[b]})}function searchCache(a,b){var c=require.resolve(a);c&&(c=require.cache[c])!==void 0&&function a(c){c.children.forEach(function(b){a(b)}),b(c)}(c)}
exports.restapi=function(a,b,c,d){var e=require("restify"),f=e.createServer(b);return f.use(function(a,b,c){return b.header("Access-Control-Allow-Origin","*"),b.header("Access-Control-Allow-Headers","X-Requested-With"),c()}),f.use(e.plugins.acceptParser(f.acceptable)),f.use(e.plugins.dateParser()),f.use(e.plugins.queryParser()),f.use(e.plugins.bodyParser({mapParams:!0})),f.get("/webrtc/details",function(a,b){console.log("params----------",a.params),b.json({type:!0,data:a.params.version})}),f.get("/session/all-sessions",function(b,c){var d=a.getAllChannels("json");c.json({type:!0,data:d})}),f.get("/session/getsession/:channelid",function(b,c){if(console.log(" [ Rest api - getSession ]  logs for ",b.params.channelid),!b.params.channelid)return void c.json({type:!0,data:"channelid is required"});var d=a.getChannel(b.params.channelid,"json");c.json({type:!0,data:d})}),f.get("/session/clients",function(b,c){var d=a.getChannelClients("json");c.json({type:!0,data:d})}),f.get("/user/all-users",function(b,c){var d=a.getAllActiveUsers("json");c.json({type:!0,data:d})}),f.get("/user/getuser/:userid",function(b,c){if(console.log(" [ Rest api - getUser ]  logs for ",b.params.userid),!b.params.userid)return void c.json({type:!0,data:"userid is required"});var d=a.getUser(b.params.userid,"json");c.json({type:!0,data:d})}),f.on("MethodNotAllowed",function(a,b){if("options"===a.method.toLowerCase()){return-1===b.methods.indexOf("OPTIONS")&&b.methods.push("OPTIONS"),b.header("Access-Control-Allow-Credentials",!0),b.header("Access-Control-Allow-Headers",["Accept","Accept-Version","Content-Type","Api-Version","Origin","X-Requested-With"].join(", ")),b.header("Access-Control-Allow-Methods",b.methods.join(", ")),b.header("Access-Control-Allow-Origin",a.headers.origin),b.send(204)}return b.send(new e.MethodNotAllowedError)}),f.listen(d.restPort,function(){console.log("%s listening at %s",f.name,f.url)}),console.log("----------------------REST APIs ----------------"),console.log(" REST server env => "+d.enviornment+" running at\n "+d.restPort),module};